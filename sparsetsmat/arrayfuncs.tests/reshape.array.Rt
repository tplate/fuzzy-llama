> reshape.array(data.frame(x=factor(c(1,1,2,4),levels=1:4),y=c("a","b","a","c"),z=1:4), 1, 2)
   a  b  c
1  1  2 NA
2  3 NA NA
4 NA NA  4
> reshape.array(data.frame(x=factor(c(1,1,2,4),levels=1:4),y=c("a","b","a","c"),z=1:4), 2, 1)
   1  2  4
a  1  3 NA
b  2 NA NA
c NA NA  4
> # Examples with out-of-order factors and character components
> x <- data.frame(x=factor(c(10,10,20,40),levels=c(10,40,20,30)),y=c("a","d","b","c"),z=1:4,stringsAsFactors=F)
> reshape.array(x, 1, 2, sort.indices=T)
    a  b  c  d
10  1 NA NA  2
20 NA  3 NA NA
40 NA NA  4 NA
> reshape.array(x, 1, 2, sort.indices=F)
    a  d  b  c
10  1  2 NA NA
40 NA NA NA  4
20 NA NA  3 NA
> reshape.array(x, 1, 2, sort.indices="x")
    a  d  b  c
10  1  2 NA NA
20 NA NA  3 NA
40 NA NA NA  4
> reshape.array(x, 1, 2, sort.indices="y")
    a  b  c  d
10  1 NA NA  2
40 NA NA  4 NA
20 NA  3 NA NA
> reshape.array(x, 1, 2, sort.indices=c("x","y"))
    a  b  c  d
10  1 NA NA  2
20 NA  3 NA NA
40 NA NA  4 NA
> # 3-d examples
> reshape.array(data.frame(x=factor(c(1,1,2,4),levels=1:4),y=c("a","b","a","c"),z=1:4), 1, 2, extra.dim=T)
, , z

   a  b  c
1  1  2 NA
2  3 NA NA
4 NA NA  4

> x <- data.frame(x=factor(c(1,1,2,4),levels=1:4),y=c("a","b","a","c"),w=(1:4)/2,z=1:4)
> x
  x y   w z
1 1 a 0.5 1
2 1 b 1.0 2
3 2 a 1.5 3
4 4 c 2.0 4
> reshape.array(x, 1, 2)
, , w

    a  b  c
1 0.5  1 NA
2 1.5 NA NA
4  NA NA  2

, , z

   a  b  c
1  1  2 NA
2  3 NA NA
4 NA NA  4

> reshape.records(reshape.array(x, 1, 2), na.rm=T, retain.dim=3)
  row col   w z 
1   1   a 0.5 1
2   2   a 1.5 3
4   1   b 1.0 2
9   4   c 2.0 4
> reshape.records(reshape.array(x, 1, 2), na.rm=T)
   row col idx3 value 
 1   1   a    w   0.5
 2   2   a    w   1.5
 4   1   b    w   1.0
 9   4   c    w   2.0
10   1   a    z   1.0
11   2   a    z   3.0
13   1   b    z   2.0
18   4   c    z   4.0
> 
> # Test behavior with need.dimnames
> reshape.array(x, 1, 2, need.dimnames=list("3", c("c","d"), c("x","y")))
, , w

    a  b  c  d
1 0.5  1 NA NA
2 1.5 NA NA NA
3  NA NA NA NA
4  NA NA  2 NA

, , x

   a  b  c  d
1 NA NA NA NA
2 NA NA NA NA
3 NA NA NA NA
4 NA NA NA NA

, , y

   a  b  c  d
1 NA NA NA NA
2 NA NA NA NA
3 NA NA NA NA
4 NA NA NA NA

, , z

   a  b  c  d
1  1  2 NA NA
2  3 NA NA NA
3 NA NA NA NA
4 NA NA  4 NA

>
> reshape.array(x, 1, 2, need.dimnames=list("3", c("d","c"), c("x","y")))
, , w

   d   a  b  c
1 NA 0.5  1 NA
2 NA 1.5 NA NA
3 NA  NA NA NA
4 NA  NA NA  2

, , x

   d  a  b  c
1 NA NA NA NA
2 NA NA NA NA
3 NA NA NA NA
4 NA NA NA NA

, , y

   d  a  b  c
1 NA NA NA NA
2 NA NA NA NA
3 NA NA NA NA
4 NA NA NA NA

, , z

   d  a  b  c
1 NA  1  2 NA
2 NA  3 NA NA
3 NA NA NA NA
4 NA NA NA  4

> reshape.array(x, 1, 2, need.dimnames=list("3", c("d","c","a","b"), c("x","y")))
, , w

   d  c   a  b
1 NA NA 0.5  1
2 NA NA 1.5 NA
3 NA NA  NA NA
4 NA  2  NA NA

, , x

   d  c  a  b
1 NA NA NA NA
2 NA NA NA NA
3 NA NA NA NA
4 NA NA NA NA

, , y

   d  c  a  b
1 NA NA NA NA
2 NA NA NA NA
3 NA NA NA NA
4 NA NA NA NA

, , z

   d  c  a  b
1 NA NA  1  2
2 NA NA  3 NA
3 NA NA NA NA
4 NA  4 NA NA

> 
> reshape.array(x, 1, 2, need.dimnames=list(character(0), c("c","d"), NULL))
, , w

    a  b  c  d
1 0.5  1 NA NA
2 1.5 NA NA NA
4  NA NA  2 NA

, , z

   a  b  c  d
1  1  2 NA NA
2  3 NA NA NA
4 NA NA  4 NA

>
> x <- array(1:48, dim=c(2,3,4,2), dimnames=list(c("A","B"),c("NA","X","Y"),c("x","NA","y","z"),c("A","B")))
> sapply(reshape.records(x), function(x) any(is.na(x)))
  row   col  idx3  idx4 value 
FALSE FALSE FALSE FALSE FALSE 
> identical(x, reshape.array(reshape.records(x),1,2,3,4, dimnames.names=F, sort.indices=F))
[1] TRUE
> identical(x, reshape.array(reshape.records(x, retain.dim=4),1,2,3, dimnames.names=F, sort.indices=F))
[1] TRUE
> x <- array(1:48, dim=c(2,6,4), dimnames=list(c("A","B"),letters[1:6],letters[23:26]))
> identical(x, reshape.array(reshape.records(x),1,2,3))
[1] TRUE
> identical(x, reshape.array(reshape.records(x,retain=3),1,2))
[1] TRUE
>
> # Some very large objects
> set.seed(1)
> x <- array(1:(2*5*11*23), dim=c(2,5,11,23), dimnames=list(letters[c(2,1)],letters[c(12,5,19,26,2)],letters[sample(26,11)],letters[sample(26,23)]))
> identical(x, reshape.array(reshape.records(x,retain=4),1,2,3,sort.indices=F,dimnames.names=F))
[1] TRUE
> x1 <- aperm(x, c(4,1,2,3))
> identical(x1, reshape.array(reshape.records(x1,retain=4),1,2,3,sort.indices=F,dimnames.names=F))
[1] TRUE
> x1 <- aperm(x, c(1,4,2,3))
> identical(x1, reshape.array(reshape.records(x1,retain=4),1,2,3,sort.indices=F,dimnames.names=F))
[1] TRUE
> x1 <- aperm(x, c(1,2,4,3))
> identical(x1, reshape.array(reshape.records(x1,retain=4),1,2,3,sort.indices=F,dimnames.names=F))
[1] TRUE
> x1 <- aperm(x, c(3,1,2,4))
> identical(x1, reshape.array(reshape.records(x1,retain=4),1,2,3,sort.indices=F,dimnames.names=F))
[1] TRUE
> x1 <- aperm(x, c(1,3,2,4))
> identical(x1, reshape.array(reshape.records(x1,retain=4),1,2,3,sort.indices=F,dimnames.names=F))
[1] TRUE
> x1 <- aperm(x, c(4,3,2,1))
> identical(x1, reshape.array(reshape.records(x1,retain=4),1,2,3,sort.indices=F,dimnames.names=F))
[1] TRUE
> x1 <- reshape.array(reshape.records(x,retain=4),1,2,3,sort.indices=T,dimnames.names=F)
> identical(x, conform.dimnames(x1, x))
[1] TRUE
> 
